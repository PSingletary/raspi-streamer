<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raspi-Streamer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>Raspi-Streamer</h1>

    <div class="tab">
        <button class="tablinks" onclick="openTab(event, 'ControlPanel')" id="defaultTab">Control Panel</button>
        <button class="tablinks" onclick="openTab(event, 'ConfigSettings')">Config Settings</button>
    </div>

    <div id="ControlPanel" class="tabcontent active">
        <button class="green" id="stream_button" onclick="toggleStream()" disabled="">Start Stream</button>
        <button class="green" id="record_button" onclick="toggleRecord()" disabled="">Start Record</button>
    </div>

    <div id="ConfigSettings" class="tabcontent">
        <form id="configForm">
            <label for="STREAM_KEY">Stream Key:</label>
            <input type="text" id="STREAM_KEY" name="STREAM_KEY" value="{{ config['STREAM_KEY'] }}" placeholder="abc123"><br>
            
            <label for="RTMP_SERVER">RTMP Server:</label>
            <input type="text" id="RTMP_SERVER" name="RTMP_SERVER" value="{{ config['RTMP_SERVER'] }}" placeholder="rtmp://192.168.0.40:1935/live/"><br>
            
            <label for="ALSA_AUDIO_SOURCE">ALSA Audio Source:</label>
            <input type="text" id="ALSA_AUDIO_SOURCE" name="ALSA_AUDIO_SOURCE" value="{{ config['ALSA_AUDIO_SOURCE'] }}" placeholder="hw:1,0"><br>
            
            <label for="VIDEO_SIZE">Video Size:</label>
            <input type="text" id="VIDEO_SIZE" name="VIDEO_SIZE" value="{{ config['VIDEO_SIZE'] }}" placeholder="1280x720"><br>
            
            <label for="FRAME_RATE">Frame Rate:</label>
            <input type="text" id="FRAME_RATE" name="FRAME_RATE" value="{{ config['FRAME_RATE'] }}" placeholder="30"><br>
            
            <label for="BITRATE">Bitrate:</label>
            <input type="text" id="BITRATE" name="BITRATE" value="{{ config['BITRATE'] }}" placeholder="3000"><br>
            
            <label for="KEYFRAME_INTERVAL">Keyframe Interval:</label>
            <input type="text" id="KEYFRAME_INTERVAL" name="KEYFRAME_INTERVAL" value="{{ config['KEYFRAME_INTERVAL'] }}" placeholder="60"><br>
            
            <label for="AUDIO_OFFSET">Audio Offset:</label>
            <input type="text" id="AUDIO_OFFSET" name="AUDIO_OFFSET" value="{{ config['AUDIO_OFFSET'] }}" placeholder="-0.8"><br>
            
            <div style="text-align:center;"><button class="default" type="submit">Update</button></div>
        </form>
        <div style="text-align:center;">
            <button class="red" onclick="sendRequest('/restart')">Restart Service</button>
            <button class="red" onclick="sendRequest('/reboot')">Reboot System</button>
            <button class="red" onclick="sendRequest('/poweroff')">Power Off</button>
        </div>
    </div>

    <script>
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.remove("active");
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.className += " active";
        }

        document.getElementById('configForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });
            fetch('/update_config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams(data)
            }).then(response => response.json())
            .then(data => alert(data.message))
            .catch(error => console.error('Error:', error));
        });

        function sendRequest(endpoint) {
            fetch(endpoint, { method: 'POST' })
                .then(response => response.json())
                .then(data => alert(data.message))
                .catch(error => console.error('Error:', error));
        }

        // Set the default tab to be active
        document.getElementById("defaultTab").click();

        let isStreaming = false;
        let isRecording = false;
        let stream_button_text = "Start Stream";
        let record_button_text = "Start Record";

        function toggleStream() {
            if (stream_button_text === "Start Stream") {
                sendRequest('/start_stream');
                stream_button_text = "Stop Stream";
                isStreaming = true;
                document.getElementById('start_record').disabled = true; 
            } else {
                sendRequest('/stop_stream');
                stream_button_text = "Start Stream";
                isStreaming = false;
                document.getElementById('start_record').disabled = false; 
            }
            
            // Toggle the class name
            document.getElementById('stream_button').classList.toggle("green");
            document.getElementById('stream_button').classList.toggle("red");
            
            document.getElementById('stream_button').innerText = stream_button_text;
        }

        function toggleRecord() {
            if (record_button_text === "Start Record") {
                sendRequest('/start_record');
                record_button_text = "Stop Record";
                isRecording = true;
                document.getElementById('start_stream').disabled = true; 
            } else {
                sendRequest('/stop_record');
                record_button_text = "Start Record";
                isRecording = false;
                document.getElementById('start_stream').disabled = false; 
            }
            
            // Toggle the class name
            document.getElementById('record_button').classList.toggle("green");
            document.getElementById('record_button').classList.toggle("red");
            
            document.getElementById('record_button').innerText = record_button_text;
        }
    </script>
</body>
</html>